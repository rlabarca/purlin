# Implementation Notes: CDD Status Monitor

*   **Test Scope:** Automated tests cover the `/status.json` API endpoint, the `status.sh` CLI tool, the underlying status logic, AND the full lifecycle integration test (Section 2.8). The lifecycle integration test eliminates the need for manual QA verification of lifecycle state transitions and role status column values -- these are fully verified by automation. Manual scenarios are reserved exclusively for web dashboard visual/UI verification. The Builder MUST NOT start the CDD server during automated tests.
*   **Visual Polish:** Use a dark, high-contrast theme suitable for 24/7 monitoring.
*   **Test Isolation:** The test aggregator scans `tests/<feature_name>/tests.json` (resolved relative to `PROJECT_ROOT`) and treats malformed JSON as FAIL.
*   **Name Convention:** Feature-to-test mapping uses the feature file's stem: `features/<name>.md` maps to `tests/<name>/tests.json`. The `<name>` must match exactly (case-sensitive).
*   **Server-Side Rendering + Client-Side Refresh:** The initial HTML page is generated server-side on first request (no static `index.html`). After initial load, the page uses a JavaScript `setInterval` (5 seconds) to `fetch('/status.json')` and update only the table body DOM. The page does NOT use `<meta http-equiv="refresh">` -- this avoids full-page reloads that cause font re-rendering, layout shift, and scroll resets.
*   **Status Logic:** `COMPLETE` requires `complete_ts > test_ts` AND either `file_mod_ts <= complete_ts` OR the only changes since the status commit are in the `## User Testing Discoveries` section (discovery-aware lifecycle preservation). To check: retrieve the file content at the status commit hash via `git show <hash>:<path>`, strip the `## User Testing Discoveries` section and everything below from both versions, and compare. If the spec content above discoveries is identical, preserve the lifecycle state. Otherwise reset to `TODO`.
*   **Escape Sequences:** Git grep patterns use `\\[` / `\\]` in f-strings to avoid Python 3.12+ deprecation warnings for invalid escape sequences.
*   **Agent Interface:** `tools/cdd/status.sh` is the primary agent interface. All agent tooling (Status Management, Context Clear Protocol, Release Protocol Zero-Queue checks) MUST use `tools/cdd/status.sh` for status queries. The `/status.json` web endpoint provides the same data for human tooling or when the server is running. Agents MUST NOT use HTTP endpoints, scrape the web dashboard, or guess port numbers.
*   **Path Normalization:** `os.path.relpath` may resolve to `.`, making `features_rel` = `./features`. The `f_path` used for git grep MUST be normalized with `os.path.normpath()` to strip the `./` prefix, otherwise status commit patterns like `[Complete features/file.md]` won't match `./features/file.md`.
*   **Section Heading Underline:** Section headings ("ACTIVE", "COMPLETE") require a visible underline separator to distinguish them from feature rows. Verified 2026-02-19.
*   **Badge "??" for missing critic.json:** SPEC_DISPUTE resolved -- spec updated from "--" to "??" for missing critic data. Verified 2026-02-20.
*   **CLI Mode:** `serve.py --cli-status` outputs API JSON to stdout and regenerates `feature_status.json`. `status.sh` is a shell wrapper that detects project root and calls this mode.
*   **Start/Stop PID Path Consistency:** `start.sh` writes PID files to `.agentic_devops/runtime/`. `stop.sh` MUST read from the same runtime directory using the same project root detection logic. A path mismatch between start and stop causes orphaned server processes and port conflicts on subsequent starts.
*   **Lifecycle Test Timing:** `test_lifecycle.sh` uses `sleep 1` between status tag commits (Ready for Verification -> Complete, Complete -> spec edit) to ensure git commit timestamps differ by at least 1 second, avoiding `int()` truncation equality in the lifecycle comparison logic.
*   **Run Critic Button:** BUG resolved 2026-02-20 — button was missing from dashboard, Builder added it. Verified: displays in top-right, enters loading state on click, refreshes dashboard with updated role columns.
*   **Port TIME_WAIT fix:** Set `allow_reuse_address = True` on `socketserver.TCPServer` in `serve.py` so the server can rebind to a port in TIME_WAIT state after stop/restart. Also added startup verification to `start.sh` — waits 0.5s and checks if the PID is still alive, reporting an error with log path if the process exited (e.g., bind failure).
*   **start.sh multi-invocation issue:** DISCOVERY resolved 2026-02-20 — port TIME_WAIT fix and startup verification resolved the need for multiple start.sh invocations after stop. Server now starts reliably on first invocation.
*   **Change Scope in API (2026-02-21):** Added `get_change_scope()` to `serve.py` — extracts `[Scope: ...]` trailer from the most recent status commit message (Complete or Ready for Verification). Included as `change_scope` field in both `/status.json` API response and internal `feature_status.json`. Omitted when no scope is declared, per spec.
*   **Purlin Branding (2026-02-21):** Implemented Section 2.9 — replaced all hardcoded hex colors with `var(--purlin-*)` CSS custom properties. Added `:root` (Blueprint dark default) and `[data-theme='light']` (Architect light) theme definitions. Inline SVG logo (mark only, no text) in header. Title updated to "Purlin CDD Monitor". Sun/moon theme toggle via CSS visibility + JS `toggleTheme()`. FOUC prevention script in `<head>` reads `purlin-theme` from localStorage before first paint. Google Fonts CDN for Montserrat (headings) and Inter (body). Monospace retained for data table cells and pre blocks.
*   **Visual Stability on Refresh (2026-02-21):** Implemented Section 2.10 — replaced `<meta http-equiv="refresh" content="5">` with JavaScript `setInterval(refreshData, 5000)` that calls `fetch('/status.json')`. The JS rebuilds only the feature table bodies (Active/Complete), using wrapper `<div>` elements with `id="active-content"` and `id="complete-content"`. The page header (logo, title, theme toggle, Run Critic button) renders once on initial server-side load and is never re-created. The timestamp updates client-side via `Date()`. The Run Critic button now calls `refreshData()` on success instead of `location.reload()`. The JS replicates Python's `_is_feature_complete()` and `_feature_urgency()` logic for Active/Complete splitting and urgency sorting.
*   **Typography Alignment (2026-02-21):** Aligned CDD and Software Map with `design_visual_standards.md` Section 2.3. Added `--font-display` and `--font-body` CSS custom properties to both `:root` and `[data-theme='light']` blocks. Updated CDN weights to Montserrat 200,800,900 and Inter 400,500,700. Page title uses `var(--font-display)` at weight 200 (ExtraLight) with `letter-spacing:0.12em;text-transform:uppercase` (wide tracking matching SVG logo treatment — thin strokes with generous spacing). Section headers (h2) use `var(--font-body)` at weight 700, uppercase, `letter-spacing:0.1em`. Sub-labels (h3) and table headers use `var(--font-body)` at weight 700, uppercase, `letter-spacing:0.1em`. All hardcoded `'Montserrat'` and `'Inter'` font-family values replaced with CSS custom property references.
*   **[CLARIFICATION]** Title font-size kept at 14px (CDD) / 14px (Software Map) despite design spec guideline of 32-40px. The compact monitoring dashboard layout requires a smaller title. The weight (200), letter-spacing (0.12em), text-transform (uppercase), and font-family (var(--font-display)) match the spec. (Severity: INFO)
*   **[CLARIFICATION]** h3 sub-labels kept at 11px (CDD) rather than the 14px section header guideline. These "Active"/"Complete" dividers function as captions/sub-labels (design spec: 10px), not full section headers. (Severity: INFO)
*   **Header right-group order fix (2026-02-21):** BUG resolved — DOM order in `.hdr-right` was [toggle][critic][timestamp], rendering visually reversed from spec Section 2.9. Fixed to [timestamp][critic-err][critic][toggle] so left-to-right reads: timestamp, Run Critic button, theme toggle (rightmost). Added inline monospace font-family to timestamp `<span>` for explicit width stability.
*   **Discovery-aware lifecycle false match (2026-02-21):** See `[BUG] strip_discoveries false match` in User Testing Discoveries below. The `strip_discoveries()` function in `serve.py` uses `text.find()` which matches a backtick-quoted reference in Section 2.1 before the actual section header. Builder must fix with a regex line-start match.
*   **Discovery-aware lifecycle bug fix (2026-02-21):** Fixed `strip_discoveries_section()` in `serve.py` — replaced `content.find('## User Testing Discoveries')` with `re.search(r'^## User Testing Discoveries', content, re.MULTILINE)`. The `find()` approach matched a backtick-quoted reference in Section 2.1 prose before the actual section header, causing false lifecycle preservation. The regex anchors to line start, matching only the real section heading.
*   **Dim contrast token (2026-02-21):** Added `--purlin-dim` CSS custom property to both `:root` (Blueprint: `#8B9DB0`) and `[data-theme='light']` (Architect: `#94A3B8`) theme blocks. Updated `.st-na` badge class from `var(--purlin-border)` to `var(--purlin-dim)` for readable "??" contrast in both themes.
*   **Project Name Display (2026-02-21):** Implemented Section 2.9 Line 2 — added project name display below the title in the CDD header. Resolved from `CONFIG.get("project_name", "")` with fallback to `os.path.basename(PROJECT_ROOT)`. Styled with `.hdr-title-block` (flex column) and `.project-name` (Inter Medium 500, 14px, `--purlin-primary`). Server-side rendered in the Python f-string template.
*   **Dynamic Workspace Section (2026-02-21):** Implemented Section 2.2 Workspace requirement. Added `/workspace.json` endpoint returning `{clean, files, last_commit}`. Repositioned Workspace `<div class="ctx">` from below the feature table to between the page header and the feature table (per spec). Added `<div id="workspace-content">` wrapper for JS targeting. Added `refreshWorkspace()` JS function called by `refreshData()` on each 5-second cycle — fetches `/workspace.json` and rebuilds workspace innerHTML. The `.ctx` class gained `margin-bottom:10px` for spacing. Refactored handler JSON response into `_send_json()` helper to reduce duplication.
*   **Lifecycle test safe cleanup (2026-02-21):** `test_lifecycle.sh` uses `git reset` (mixed, no `--hard`) during cleanup. This undoes test commits but preserves the working tree, so uncommitted code changes are never destroyed. Temp files are removed with `rm -rf`.
*   **Visual Design Standards Compliance (2026-02-21):** Prior impl notes described branding/theme/typography as "done" but the code had regressed to pre-implementation state. Full re-implementation: (1) Added `:root` (Blueprint dark) and `[data-theme='light']` (Architect light) CSS custom property blocks with all `--purlin-*` tokens per `design_visual_standards.md` Section 2.2. (2) Google Fonts CDN `<link>` tags for Montserrat 200,800,900 and Inter 400,500,700. (3) FOUC prevention synchronous `<script>` in `<head>` reads `localStorage('purlin-theme')` before first paint. (4) Title h1 uses `var(--font-display)`, weight 200 (ExtraLight), `letter-spacing:0.12em`, `text-transform:uppercase`. (5) Inline SVG logo mark (~24px height) with `.logo-sketch` and `.logo-fill` CSS classes for theme-responsive fills. (6) Project name rendered server-side via `{PROJECT_NAME}` f-string in `.hdr-title-block`. (7) Sun/moon theme toggle button with `toggleTheme()` JS — toggles `data-theme` attribute on `<html>`, persists to localStorage, updates icon visibility, re-renders graph if on map view. (8) All hardcoded hex replaced with `var(--purlin-*)` tokens in status badges, workspace states, modals, buttons, etc. (9) Status column headers (Architect/Builder/QA `<th>`) centered via `.badge-col` class. (10) Timestamp `<span>` given `id="last-refreshed"` with explicit monospace font; `updateTimestamp()` JS called on each refresh cycle. (11) Section headers use `var(--font-body)` Inter Bold 700, uppercase, `letter-spacing:0.1em`.

*   **Two-Row Header Layout (2026-02-21):** Refactored `.hdr` from single flex row to column container with `.hdr-row1` and `.hdr-row2`. Row 1: `.hdr-row1-left` (logo + title block) and `.hdr-row1-right` (timestamp + theme toggle). Row 2: `.hdr-row2-left` (view toggle buttons) and `.hdr-row2-right` (Run Critic button + search input). Both rows use `justify-content:space-between`. Row separator: 1px `border-top` on `.hdr-row2` using `var(--purlin-border)`. `.hdr-row2-right` uses `gap:6px` for consistent spacing between Critic button and search input.
*   **Section State Persistence (2026-02-21):** Section expanded/collapsed states persisted to `localStorage` key `purlin-section-states` as JSON object mapping section IDs to `"collapsed"` or `"expanded"`. `applySectionStates()` reads localStorage and applies states on page load and after each auto-refresh DOM replacement. `saveSectionStates()` called from `toggleSection()` on every click. `refreshStatus()` simplified — instead of scanning DOM for collapsed classes before innerHTML replacement, it now calls `applySectionStates()` after replacement to restore from localStorage.
*   **Workspace Collapsed Default (2026-02-21):** Changed Workspace section from expanded-by-default to collapsed-by-default, matching Complete section behavior. Removed `expanded` class from workspace chevron, added `collapsed` class to workspace section-body, computed `workspace_summary` server-side ("Clean State" green badge or "{N} file(s) changed" yellow badge) and injected into workspace-section-badge span.

## SW Map View -- Merged Tribal Knowledge (from retired software_map_generator.impl.md)

*   **Acyclic Mandate:** The graph generation tool is the primary enforcer of the acyclic graph rule defined in the workflow.
*   **Agent Interface (Graph):** `.agentic_devops/cache/dependency_graph.json` is the single machine-readable contract for the dependency graph. All agent tooling (Context Clear Protocol, Dependency Integrity checks, Release Protocol) MUST read this file. CLI access is via `tools/cdd/status.sh --graph`.
*   **Cycle Detection:** Uses DFS with 3-color marking (WHITE/GRAY/BLACK). External prerequisites (not in the features directory) are skipped without triggering false positives.
*   **File Watch Mode:** `serve.py` polls `features/` directory every 2 seconds using `os.scandir` mtime snapshots. No external dependencies required (no `watchdog`).
*   **Deterministic JSON (Graph):** `dependency_graph.json` uses `sort_keys=True` on `json.dump` and all arrays are pre-sorted by filename/path before serialization.
*   **Label Wrapping:** SVG label generator uses word-wrap logic (`wrapText()`) to split long labels into multiple lines within the node box. Each label line is rendered as a `<tspan>` element. Node height is dynamically computed based on the number of wrapped lines (base 44px + 18px per extra line). Max ~22 chars per line at font-size 14 in monospace.
*   **Reactive Update Testing:** The "Reactive Update on Feature Change" scenario requires the running server (`serve.py`) and is classified as Manual. File-watch regeneration is verified during Human Verification.
*   **Reactive Refresh Resilience:** Fixed two issues that could cause stale category data on reactive refresh: (1) In `generate_tree.py`, `generate_dependency_graph()` now runs BEFORE `update_outputs()` (Mermaid/README), so the critical JSON output is written even if README update fails. (2) In `serve.py`, the file watcher snapshot is only updated on successful generation -- failed generations trigger retry on the next poll cycle. Builder audit (2026-02-20): full code trace confirms the reactive path is correct -- watcher detects mtime changes, subprocess re-parses features (including Category), writes updated JSON, web UI fetches with cache-busting and rebuilds Cytoscape graph with new category groupings. Needs QA re-verification with server running.
*   **Cytoscape.js Theme Integration (2026-02-21):** JS `getThemeColors()` reads computed CSS custom properties for Cytoscape styles. `createNodeLabelSVG()` accepts `colors` parameter for theme-responsive SVG `fill` values. `createCytoscape()` accepts `colors` for category parent bg, borders, edges, hover highlights. On `toggleTheme()`, `renderGraph()` is called which destroys and recreates the Cytoscape instance with new colors (preserving zoom/pan via existing viewport state logic).
*   **SW Map Port TIME_WAIT fix (2026-02-21):** Set `allow_reuse_address = True` on `socketserver.TCPServer` in `serve.py` so the server can rebind to a port in TIME_WAIT state after stop/restart. Added startup verification to `start.sh`. Same pattern as the CDD Monitor fix. (Historical -- SW Map server retired; pattern preserved in unified dashboard server.)
*   **SW Map Project Name Display (2026-02-21):** Implemented project name below title -- `serve.py` resolves `PROJECT_NAME` from `config.get("project_name", "")` with fallback to `os.path.basename(PROJECT_ROOT)`. Injected as `_resolved_project_name` in the `/config.json` endpoint response. `index.html` loads it via `loadProjectName()` on init. (Historical -- now unified in CDD Dashboard server-side rendering.)
*   **Delivery Phase Indicator (2026-02-21):** Implemented Section 2.11. Added `get_delivery_phase()` to `serve.py` — reads `.agentic_devops/cache/delivery_plan.md`, parses `### Phase N:` headings and their `**Status:**` lines, returns `{"current": <first_pending_or_in_progress>, "total": <count>}` or `None`. Integrated into `generate_api_status_json()` — `delivery_phase` field included when plan exists with non-COMPLETE phases, omitted otherwise. Dashboard ACTIVE section heading displays `[PHASE (X/Y)]` annotation inline (styled with `--purlin-status-todo` yellow). Annotation appears in both expanded and collapsed states (injected into the `<h3>` tag). The annotation auto-refreshes via the existing `refreshStatus()` JS cycle since it re-fetches the full HTML and replaces `status-view` innerHTML. CLI mode gets delivery_phase for free since it calls `generate_api_status_json()`.
