# Implementation Notes: Submodule Bootstrap

*   **Shell Compatibility:** Use `#!/bin/bash` with POSIX-compatible patterns where possible. Avoid bashisms that would fail on older systems.
*   **Temp File Cleanup:** Launcher scripts MUST use `trap "rm -f '$PROMPT_FILE'" EXIT` to ensure cleanup even on error.
*   **Config Patching (sed safety):** The sed regex for `tools_root` must be precise: replace only the value between quotes, not the entire line. Use a pattern like `s|"tools_root": "[^"]*"|"tools_root": "NEW_VALUE"|` which matches the shortest quoted string and preserves trailing commas. Do not require `jq` as a dependency. Always validate the result with `python3 json.load()`.
*   **Idempotent Gitignore:** When appending recommended ignores, check each line before adding to avoid duplicates.
*   **Start Script Climbing:** When `AGENTIC_PROJECT_ROOT` is not set, shell start scripts use a two-step fallback. Note the order was reversed from the original implementation: try submodule path (`$DIR/../../../.agentic_devops/config.json`) first, then standalone path (`$DIR/../../.agentic_devops/config.json`). When `AGENTIC_PROJECT_ROOT` IS set, scripts use `$AGENTIC_PROJECT_ROOT/.agentic_devops/config.json` directly.
*   **Python Climbing Priority:** The climbing order in Python tools was a source of bugs. The standalone path (`../../`) is nearer and matches first, but in submodule mode this resolves to the submodule's own `.agentic_devops/`, not the consumer project's. The fix is: (1) always prefer `AGENTIC_PROJECT_ROOT` if set, (2) when climbing, try the further path (`../../../`) before the nearer path (`../../`).
*   **Artifact Isolation:** The `.agentic_devops/runtime/` and `.agentic_devops/cache/` directories are gitignored. Tools must `os.makedirs(..., exist_ok=True)` before writing. Existing code that reads `feature_status.json` or `dependency_graph.json` from `tools/` subdirectories must be updated to read from the cache directory. The Critic reads `feature_status.json` via `_read_cdd_feature_status()` -- this path must change.
*   **Config Resilience Pattern:** All Python tools should use a shared helper or consistent pattern: `try: CONFIG = json.load(f) except (json.JSONDecodeError, IOError, OSError): print("Warning: ...", file=sys.stderr); CONFIG = {}`. Then use `.get()` with defaults for all config values.
*   **Submodule Simulation Test Architecture:** The existing `test_bootstrap.sh` already creates a sandbox with `setup_sandbox()` that clones the repo and overlays scripts. This sandbox was extended to test the new scenarios (Sections 2.10-2.14). Key additions: (1) After bootstrap, run `python3 -c "import json; json.load(open(...))"` on the patched config.json. (2) Set `AGENTIC_PROJECT_ROOT` and invoke Python tools to verify they use it. (3) Write a malformed config.json and verify tools fall back gracefully. (4) Check that `AGENTIC_PROJECT_ROOT` appears in generated launcher scripts. The sandbox cleanup already uses `trap cleanup_sandbox EXIT` which handles failure cases.
*   **Software Map serve.py Route Update:** When `dependency_graph.json` moved to `.agentic_devops/cache/`, the Software Map serve.py needed a new explicit route for `/dependency_graph.json` requests to serve from the cache directory, since the default static file handler serves from the tool's directory.
*   **Gitignore Test Precision:** The test assertion for "gitignore does not ignore .agentic_devops" was updated from a broad pattern match to an exact-line regex (`^\\.agentic_devops/?$`) to avoid false positives from the new `.agentic_devops/runtime/` and `.agentic_devops/cache/` gitignore entries.
