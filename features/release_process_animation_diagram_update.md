# Feature: Process Animation Diagram Update

> Label: "Release Step: Workflow Animation"
> Category: "Release Process"
> Prerequisite: features/policy_release.md
> Prerequisite: features/design_visual_standards.md
> Prerequisite: features/release_checklist_core.md

## 1. Overview

This feature adds an animated GIF to the Purlin README that shows the Architect, Builder, and QA agents cycling through a feature's complete lifecycle alongside the Critic/CDD dashboard and the `features/` directory. The animation serves as a visual explainer for the "How It Works" section of the README.

**Output:** `assets/workflow-animation.gif` (generated by `dev/generate_workflow_animation.py`)

**Toolchain:** Mermaid CLI (`mmdc`) for diagram rendering, Python 3.8+ for orchestration, ImageMagick (`convert`) for caption compositing and GIF assembly.

**Ownership:**
- `features/release_process_animation_diagram_update.md` and `features/release_process_animation_diagram_update.impl.md` — Architect-owned.
- `dev/generate_workflow_animation.py` — Builder-owned.
- `.agentic_devops/release/local_steps.json` — Architect-owned (delegated to Builder for creation).

## 2. Requirements

### 2.1 Output File

*   The script MUST write the final animation to `assets/workflow-animation.gif`, relative to the project root.
*   Canvas size: 800×500px.
*   Loop: infinite (GIF loop count = 0).

### 2.2 README Embedding

*   After generating the GIF, the script MUST check `README.md` for an existing reference to `assets/workflow-animation.gif`.
*   If absent, the script MUST insert the following Markdown image tag immediately after the `## How It Works` heading:
    ```
    ![Purlin Agent Workflow](assets/workflow-animation.gif)
    ```
*   This operation MUST be idempotent: if the reference already exists, the script MUST NOT insert a duplicate.
*   If no `## How It Works` heading exists in `README.md`, the script MUST log a warning and skip the README update without failing.

### 2.3 Toolchain Requirements

At startup, the script MUST perform dependency checks:

*   **`mmdc`** — Mermaid CLI. If absent, the script MUST exit with a non-zero code and print a clear error message instructing the user to install it (e.g., `npm install -g @mermaid-js/mermaid-cli`). The script MUST NOT attempt auto-installation of `mmdc`.
*   **Python 3.8+** — Required for the script itself. If the interpreter version is below 3.8, the script MUST exit with a clear version error.
*   **ImageMagick `convert`** — If absent, the script MUST detect the platform and auto-install before proceeding:
    *   **macOS** (detected via `uname -s == "Darwin"`): run `brew install imagemagick`.
    *   **Debian/Linux** (detected via existence of `/etc/debian_version` or availability of `apt-get`): run `apt-get install -y imagemagick`.
    *   **Unsupported platform**: exit with a clear error message naming the platform and instructing the user to install ImageMagick manually.

### 2.4 Release Step Registration

The Builder MUST create `.agentic_devops/release/local_steps.json` containing the following step:

```json
{
  "steps": [
    {
      "id": "workflow_animation",
      "friendly_name": "Update Workflow Animation",
      "description": "Generates assets/workflow-animation.gif showing the Purlin agent lifecycle and embeds it in README.md under the '## How It Works' heading.",
      "code": "python3 dev/generate_workflow_animation.py",
      "agent_instructions": "Run `python3 dev/generate_workflow_animation.py` from the project root. Confirm exit code 0, that `assets/workflow-animation.gif` was created or updated, and that `README.md` contains exactly one reference to `assets/workflow-animation.gif` under the `## How It Works` heading."
    }
  ]
}
```

Note: the `id` field uses NO `purlin.` prefix, per `policy_release.md` Invariant 2.1.

### 2.5 Mermaid Base Diagram

The script uses a Mermaid flowchart as the visual base for each frame.

*   **Theme:** Blueprint Dark (`%%{init: {'theme': 'dark', 'themeVariables': {'background': '#0B131A', 'primaryColor': '#162531', 'primaryTextColor': '#E2E8F0', 'edgeLabelBackground': '#162531', 'clusterBkg': '#162531'}}}%%`)
*   **Layout:** Top-down hub-spoke. Five nodes: `ARCH`, `QA`, `BLDR`, `CRITIC` (hub), `FEAT`. The hub (`CRITIC`) sits at center; the four agents and the feature node branch from it.
*   **Base edges:** All inter-node connections are defined as dotted arrows (`-.->`) in the base diagram, establishing invisible structural connections. Active edges per frame override to solid accent-colored arrows via CSS class injection.

**Node labels:**
| ID | Display Label |
|----|---------------|
| `CRITIC` | `Critic / CDD` |
| `ARCH` | `Architect` |
| `BLDR` | `Builder` |
| `QA` | `QA Agent` |
| `FEAT` | `features/` |

### 2.6 Caption Panel

*   Each frame includes an 800×40px caption panel composited below the 800×460px diagram area to form the 800×500px output.
*   Background color: `#162531` (Blueprint Dark surface).
*   Text color: `#E2E8F0` (Blueprint Dark primary text).
*   Font: Inter (with system sans-serif fallback if Inter is unavailable in the ImageMagick font registry).
*   Caption text is centered horizontally, vertically centered within the 40px panel.

### 2.7 Canonical Animation Sequence

The following 16-frame sequence is the **source of truth** for the animation. The Builder MUST embed this sequence as a data structure in the script, derived directly from this spec. The spec MUST NOT be reverse-engineered from the script.

Each frame definition:

| Field | Description |
|-------|-------------|
| `id` | Unique scene identifier (snake_case) |
| `scene` | Human-readable scene name |
| `caption` | Text rendered in the caption panel |
| `highlight` | Map of node ID → CSS class (`active`, `warning`, `success`) |
| `active_arrows` | List of `{from, to}` pairs for solid accent arrows |
| `duration_ms` | Frame hold time in milliseconds |

**Frame Table:**

| # | `id` | `scene` | `caption` | Active Nodes | Arrows | `duration_ms` |
|---|------|---------|-----------|--------------|--------|---------------|
| 1 | `title` | Title | "Purlin: Continuous Design-Driven Development" | CRITIC (active) | — | 2000 |
| 2 | `critic_intro` | Critic Intro | "The Critic coordinates the project..." | CRITIC (active) | — | 2000 |
| 3 | `arch_reads_critic` | Architect Reads Critic | "Architect reads the Critic report..." | ARCH (active), CRITIC (active) | ARCH→CRITIC | 2000 |
| 4 | `arch_writes_feature` | Architect Writes Feature | "Architect designs a feature specification in features/" | ARCH (active), FEAT (active) | ARCH→FEAT | 2000 |
| 5 | `critic_detects_feature` | Critic Detects Feature | "Critic detects the new feature — status: [TODO]" | CRITIC (active), FEAT (active) | CRITIC→FEAT | 2000 |
| 6 | `builder_reads_critic` | Builder Reads Critic | "Builder reads Critic report: feature is ready..." | BLDR (active), CRITIC (active) | BLDR→CRITIC | 2000 |
| 7 | `builder_reads_feature` | Builder Reads Feature | "Builder reads feature spec and begins implementation" | BLDR (active), FEAT (active) | BLDR→FEAT | 2000 |
| 8 | `builder_marks_ready` | Builder Marks Ready | "Builder marks feature [Ready for Verification]" | BLDR (active), FEAT (active) | BLDR→FEAT | 2000 |
| 9 | `critic_flags_qa` | Critic Flags QA | "Critic flags the feature for QA verification" | CRITIC (active), FEAT (active) | CRITIC→FEAT | 2000 |
| 10 | `qa_reads_critic` | QA Reads Critic | "QA reads Critic action items" | QA (active), CRITIC (active) | QA→CRITIC | 2000 |
| 11 | `qa_reads_scenarios` | QA Reads Scenarios | "QA executes manual scenarios from the feature spec" | QA (active), FEAT (active) | QA→FEAT | 2000 |
| 12 | `qa_records_bug` | QA Records Bug | "QA records a [BUG] discovery in the feature spec" | QA (active), FEAT (**warning**) | QA→FEAT | 2000 |
| 13 | `arch_revises_spec` | Architect Revises Spec | "Architect revises the spec to address the discovery" | ARCH (active), FEAT (active) | ARCH→FEAT | 2000 |
| 14 | `builder_reimplements` | Builder Reimplements | "Builder re-implements to match the updated spec" | BLDR (active), FEAT (active) | BLDR→FEAT | 2000 |
| 15 | `qa_verifies_clean` | QA Verifies Clean | "QA verifies all scenarios pass — status: CLEAN" | QA (active), FEAT (**success**) | QA→FEAT | 2000 |
| 16 | `release_ready` | Release Ready | "Critic signals all features CLEAN — ready for release!" | ALL (**success**) | — | 3000 |

**CSS class → visual mapping for nodes:**
| Class | Color |
|-------|-------|
| `active` | Sky blue (`#38BDF8`) |
| `warning` | Orange (`#F97316`) |
| `success` | Green (`#34D399`) |

**Active arrow color:** Sky blue (`#38BDF8`), solid line, arrowhead.

### 2.8 Script Entry Point

The canonical invocation is:
```
python3 dev/generate_workflow_animation.py
```

Run from the project root. The script MUST detect the project root via the `AGENTIC_PROJECT_ROOT` environment variable first, then by climbing the directory tree (submodule-safe). All output paths are resolved relative to the detected project root.

## 3. Scenarios

### Automated Scenarios

#### Scenario: Generator produces GIF on success
Given all dependencies (`mmdc`, Python 3.8+, ImageMagick `convert`) are present on the system,
When `python3 dev/generate_workflow_animation.py` is executed from the project root,
Then the script exits with code 0,
And `assets/workflow-animation.gif` is created (or overwritten) at the project root,
And the file is a valid GIF with an infinite loop setting.

#### Scenario: Generator exits with error when mmdc is absent
Given `mmdc` is not on the system PATH,
When `python3 dev/generate_workflow_animation.py` is executed,
Then the script exits with a non-zero code,
And the error output names `mmdc` as the missing dependency,
And the error output includes installation guidance (e.g., `npm install -g @mermaid-js/mermaid-cli`).

#### Scenario: Generator auto-installs ImageMagick when absent
Given ImageMagick `convert` is not on the system PATH,
And `mmdc` is present,
And Python 3.8+ is the active interpreter,
When `python3 dev/generate_workflow_animation.py` is executed on macOS,
Then the script invokes `brew install imagemagick` before rendering,
And after installation, the script proceeds to generate `assets/workflow-animation.gif`,
And the script exits with code 0.

#### Scenario: README embedding is idempotent
Given `assets/workflow-animation.gif` has already been generated,
And `README.md` already contains `![Purlin Agent Workflow](assets/workflow-animation.gif)` under `## How It Works`,
When the script is run a second time,
Then `README.md` contains exactly one occurrence of `![Purlin Agent Workflow](assets/workflow-animation.gif)`.

#### Scenario: README embedding inserts reference when absent
Given `README.md` contains a `## How It Works` heading,
And `README.md` does NOT contain any reference to `assets/workflow-animation.gif`,
When the script runs to completion,
Then `README.md` contains `![Purlin Agent Workflow](assets/workflow-animation.gif)` immediately following the `## How It Works` heading.

### Manual Scenarios

#### Scenario: Animation is visually correct and coherent
Given `assets/workflow-animation.gif` has been generated,
When a human opens the file in a browser or image viewer,
Then they can verify all items in the Visual Specification checklist below.

## Visual Specification

### Screen: Workflow Animation GIF

- **Reference:** N/A
- [ ] Animation loops continuously without visible flicker between frames.
- [ ] Blueprint Dark background (`#0B131A`) fills the full canvas throughout all frames.
- [ ] All 5 nodes (`Architect`, `Builder`, `QA Agent`, `Critic / CDD`, `features/`) are legible in a hub-spoke layout with `Critic / CDD` at center.
- [ ] Active nodes render in sky blue; warning nodes in orange; success nodes in green.
- [ ] Frame 12 (`qa_records_bug`): `features/` node renders in the warning (orange) style.
- [ ] Frame 15 (`qa_verifies_clean`): `features/` node renders in the success (green) style.
- [ ] Frame 16 (`release_ready`): all nodes render in the success (green) style.
- [ ] Active arrows are solid sky-blue lines with arrowheads; inactive connections are not prominently visible.
- [ ] Caption panel (bottom 40px) displays correct per-frame text, centered, in `#E2E8F0` on `#162531`.
- [ ] The sequence reads as a coherent Purlin workflow narrative from title (frame 1) to release (frame 16).

## Implementation Notes

See [release_process_animation_diagram_update.impl.md](release_process_animation_diagram_update.impl.md) for implementation knowledge, builder decisions, and tribal knowledge.

## User Testing Discoveries

### [BUG] Agent nodes not arranged in hub-spoke layout around Critic/CDD (Discovered: 2026-02-22)
- **Scenario:** Animation is visually correct and coherent
- **Observed Behavior:** All agent nodes (Architect, Builder, QA Agent, features/) are lined up horizontally at the top of the canvas with curvy arrows connecting them. The Critic/CDD node is not visually centered as a hub.
- **Expected Behavior:** Per Section 2.5, Critic/CDD is the hub at center with the four agent/feature nodes arranged around it in a spoke pattern. The user expected a triangular or radial arrangement around the hub.
- **Action Required:** Builder — fix the Mermaid layout or post-processing to produce a true hub-spoke arrangement. Architect may also want to add a visual diagram reference to Section 2.5 to make the intended layout unambiguous.
- **Status:** RESOLVED

### [BUG] Caption panel missing from all frames (Discovered: 2026-02-22)
- **Scenario:** Animation is visually correct and coherent
- **Observed Behavior:** No caption text block appears at the bottom of any frame. The per-frame description text (e.g., "Purlin: Continuous Design-Driven Development") is absent.
- **Expected Behavior:** Per Section 2.6, each frame must include an 800×40px caption panel composited below the 800×460px diagram area, displaying the per-frame caption text centered in `#E2E8F0` on a `#162531` background.
- **Action Required:** Builder — implement the caption panel compositing step in `dev/generate_workflow_animation.py`.
- **Status:** RESOLVED
